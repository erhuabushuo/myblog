Title: å‡çº§åˆ°PHP7
Date: 2016-03-14 11:55
Category: PHP

æ€»ç»“è®°å½•PHP7ä¸€äº›æ–°ç‰¹æ€§

## æ›´æ–°åˆ°PHP7

PHP7æ˜¯åå¹´æ¥PHPæœ€å¤§çš„å‡çº§ï¼Œé‡æ–°æ„å»ºZend Engine3ï¼Œ ä¼—å¤šæ–°ç‰¹æ€§ï¼Œé€Ÿåº¦æå‡ï¼Œå°½é‡å…¼å®¹ã€‚ç°åœ¨å‡çº§å¸¦æ¥æ— é™å¥½å¤„ã€‚

### PHP7æ—¶é—´çº¿

å‡çº§åˆ°PHP7ï¼Œæ¯”ä»5.2å‡çº§åˆ°5.3è¿˜è¦å®¹æ˜“

### PHP6å‘¢ï¼Ÿ

2005åˆ°2010ä¸€ç›´åœ¨è¿›è¡ŒPHP6å¼€å‘ï¼Œæœ€ç»ˆç”±äºç§ç§å›°éš¾å–æ¶ˆï¼Œä¸è¿‡åœ¨å°†è®¸å¤šç‰¹æ€§åˆå¹¶åœ¨äº†PHP5.3ï¼Œæœ€é‡è¦çš„æ˜¯åˆå¹¶äº†å®Œå…¨å†…ç½®çš„UNICODEæ”¯æŒã€‚è¯¦æƒ…æŸ¥çœ‹ï¼š[https://wiki.php.net/rfc/php6](https://wiki.php.net/rfc/php6)

## åºŸå¼ƒçš„ç‰¹æ€§

PHP 5.xæ ‡æ³¨åºŸå¼ƒçš„ç‰¹æ€§å·²ç»åœ¨PHP7.0ç§»é™¤

### æ›¿ä»£çš„PHPæ ‡ç­¾

**scriptæ ‡ç­¾**

    <script language="php">
        // æˆ‘çš„ä»£ç 
    </script>

**ASPæ ‡ç­¾**

    <%
        // æˆ‘çš„ä»£ç 
    %>
    
    <%=$varToEcho; %>
    
### POSIXå…¼å®¹çš„æ­£åˆ™è¡¨è¾¾å¼

* ereg()
* eregi()
* ereg_replace()
* eregi_replace()
* split()
* spliti()
* sql_regcase()

è¿ç§»åˆ°Perlå…¼å®¹æ­£åˆ™è¡¨è¾¾å¼preg_å¤§å®¶åº­ã€‚

### Switchæ”¯æŒå¤šä¸ªdefaultå­å¥

    switch ($expr) {
        default:
          echo "Hi!";
          break;
        default:
          echo "Bye!";
          break;
    }

Fatal error: Switch statements may only contain one default clause

### ç§»é™¤åŸå§‹çš„MySQLæ‰©å±•

ç§»é™¤mysql_

* ä½¿ç”¨mysqli
* ä½¿ç”¨PDO


## ç»Ÿä¸€å˜é‡è¯­æ³•

å‚è€ƒ

[https://wiki.php.net/rfc/uniform_variable_syntax](https://wiki.php.net/rfc/uniform_variable_syntax)

$object->$array[key]

### ä¿®æ­£ä¸€è‡´æ€§

    // Syntax
    $$var['key1']['key2'];
    // PHP 5.x:
    // Using a multidimensional array value as variable name
    ${$var['key1']['key2']};
    // PHP 7:
    // Accessing a multidimensional array within a variable-variable
    ($$var)['key1']['key2'];
    
    // Syntax
    $var->$prop['key'];
    // PHP 5.x:
    // Using an array value as a property name
    $var->{$prop['key']};
    // PHP 7:
    // Accessing an array within a variable-property
    ($var->$prop)['key'];
    

    // Syntax
    $var->$prop['key']();
    // PHP 5.x:
    // Using an array value as a method name
    $var->{$prop['key']}();
    // PHP 7:
    // Calling a closure within an array in a variable-property
    ($var->$prop)['key']();
    
    // Syntax
    ClassName::$var['key']();
    // PHP 5.x:
    // Using an array value as a static method name
    ClassName::{$var['key']}();
    // PHP 7:
    // Calling a closure within an array in a static variable
    (ClassName::$var)['key']();

### æ–°è¯­æ³•

#### è¯­æ³•ç»„åˆ
    
    // Call a closure inside an array returned by another closure
    $foo()['bar']();
    
    // Call a property by dereferencing an array literal
    [$obj1, $obj2][0]->prop;
    
    // Access a character by index in a returned string
    getStr(){0};
    
#### æ½œé€ƒåŒå†’å·

    // Access a static property on a string class name
    // or object inside an array
    $foo['bar']::$baz;
    
    // Access a static property on a string class name or object
    // returned by a static method call on a string class name
    // or object
    $foo::bar()::$baz;
    
    // Call a static method on a string class or object returned by
    // an instance method call
    $foo->bar()::baz();

#### åµŒå¥—æ–¹æ³•å’Œå‡½æ•°è°ƒç”¨

    / Call a callable returned by a function
    foo()();
    
    // Call a callable returned by an instance method
    $foo->bar()();
    
    // Call a callable returned by a static method
    Foo::bar()();
    
    // Call a callable return another callable
    $foo()();

#### æŠ½è±¡è¡¨è¾¾å¼å¼•ç”¨

    (expression)['foo'];
    
    // Access a property
    (expression)->foo;
    
    // Call a method
    (expression)->foo();
    
    // Access a static property
    (expression)::$foo;
    
    // Call a static method
    (expression)::foo();
    
    // Call a callable
    (expression)();
    
    // Access a character
    (expression){0};
    
    // Define and immediately call a closure without assignment
    (function() { /* ... */ })();
    
    // Call a callable within an object property
    ($obj->callable)();

### æ ‡é‡å¼•ç”¨

    // Call a dynamic static method
    ["className", "staticMethod"]();
    
    // Call a dynamic instance method
    [$object, "method"]();
    
    // Use a string scalar as a class name
    'className'::staticMethod();

### æœªæ¥å¯èƒ½æ–°å¢è¯­æ³•

    // Object scalars â€” method calls on scalar values
    "string"->toLower();

### å‘åå…¼å®¹é—®é¢˜

    global $$foo->bar; // Now a parse error
    
    // instead make sure to add braces to make it unambiguous
    global ${$foo->bar};

## åŸºæœ¬è¯­æ³•å˜æ›´

### æ“ä½œç¬¦

#### ??

    $foo = isset($bar) ? $bar : $baz;
    
    $foo = $bar ?? $baz;

è¿˜æ˜¯æ”¯æŒåµŒå¥—

    $config =   $config ??
              $this->config ??
              static::$defaultConfig;

#### <=>

* -1:å·¦è¾¹å°äºå³è¾¹
* 0:ä¸¤è¾¹ç›¸ç­‰
* +1:å·¦è¾¹å¤§äºå³è¾¹

PHP7ä¹‹å‰

    function order_func_traditional($a, $b) {
      return ($a < $b) ? -1 : (($a > $b) ? 1 : 0);
    }

PHP7ä¹‹å
    
    function order_func_spaceship($a, $b) {
      return $a <=> $b;
    }

### æ•°ç»„å¸¸é‡

    define('FOO', [
    'bar' => 'baz',
    'bat' => 'qux'
    ])
    
    echo FOO['bar'];

### ä½¿ç”¨list()å¯¹è±¡è§£åŒ…

listæ„é€ å…è®¸è§£åŒ…å®ç°äº†\ArrayAccessæ¥å£å¯¹è±¡

    $object = new \ArrayObject(json_decode($json));
    list($foo, $bar, $baz) = $object;

### æ–°å‡½æ•°
    
    intdiv(8, 3);

### æ­£åˆ™è¡¨è¾¾å¼

**preg_replace_callback_array()**æä¾›äº†æ›´å¥½çš„å›è°ƒæ–¹å¼å¤„ç†å¤šæ¨¡å¼æ›¿æ¢



    $header = "X-Custom-Header: foo\nbar";
    
    $normalizedHeader = preg_replace_callback_array(
        [
            "/(.*?):/" => function($matches) {
                return strtolower($matches[0]);
            },
            "/\s+/" => function($matches) {
                return "-";
            }
        ],
        $header
    );

å¹¶ä¸”ç§»é™¤äº†preg_replace()ï¼Œä½ éœ€è¦ä½¿ç”¨preg_replace_callback()æˆ–è€…preg_replace_callback_array()

### å¯†ç å®‰å…¨å€¼

random_bytes()å’Œrandom_int()

    random_bytes(16);
    random_int(0, 10000);

### å‡½æ•°å˜æ›´

session_start()å¯æ¥æ”¶æ•°ç»„å‚æ•°

    session_start([
      'use_strict' => true,
      'lazy_write' => falseã€€ã€€//ã€€åªåœ¨æ›´æ”¹è¿‡sessionæ‰å†™
    ]);

### unserialize

unserializeå¢åŠ äº†ç¬¬äºŒä¸ªå¯é€‰æ•°ç»„å‚æ•°ï¼ŒæŒ‡æ˜å¯ä»¥è½¬æ¢çš„ç±»ï¼Œæˆ–è€…é€šè¿‡FALSEæ¥ç¦æ­¢ç±»è½¬æ¢ï¼ŒTRUEåˆ™å…è®¸æ‰€æœ‰ç±»è½¬æ¢

### dirname

dirname()æ”¯æŒå¯é€‰ç¬¬äºŒä¸ªå‚æ•°æ¥é™å®šå¤šå°‘å±‚

    $path = '/foo/bar/bat/baz';
    dirname($path, 2);
    
### password_hash()

ç§»é™¤password_hash()çš„optioné‡Œsaltå‚æ•°

## æ–­è¨€

assert()æ ¹æ®[https://wiki.php.net/rfc/expectations](https://wiki.php.net/rfc/expectations)è¿›è¡Œäº†æ‰©å±•ï¼Œå…è®¸ç§°ä¸º zero-costæ–­è¨€,ä¸ä½†å¯ä»¥ç¦ç”¨æ–­è¨€ï¼Œè€Œä¸”å¯ä»¥ç§»é™¤æ‰€æœ‰çš„å¼€é”€ã€‚è®¾ç½®åæ–­è¨€å°†ä¸è¢«ç¼–è¯‘ã€‚é€šè¿‡INIé…ç½®zend.assertionsæ›´æ”¹

    zend.assertions  = 1  # å¼€å¯
    zend.assertions  = 0  # å…³é—­
    zend.assertions  = -1 # Zero-cost

assert()å¢åŠ äº†ç¬¬äºŒä¸ªå‚æ•°ï¼Œå…è®¸æŒ‡å®šè‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ï¼Œæˆ–è€…å¼‚å¸¸ã€‚

## é”™è¯¯å¤„ç†

[https://wiki.php.net/rfc/engine_exceptions_for_php7](https://wiki.php.net/rfc/engine_exceptions_for_php7)ä¸­æè¿°äº†PHP 7.0é”™è¯¯å¤„ç†çš„å˜æ›´

### æ„é€ å¤±è´¥å¼‚å¸¸

æ—©äºPHP 7.0ï¼Œå¦‚æœå†…éƒ¨ç±»åœ¨åˆå§‹åŒ–å±æ€§å¤±è´¥æ—¶ï¼Œå°†è¿”å›nullæˆ–unusable object.PHP 7.0æ‰€æœ‰çš„å†…éƒ¨ç±»åœ¨åˆå§‹åŒ–å¤±è´¥æ—¶å°†æŠ›å‡ºå¼‚å¸¸ã€‚
    
    try {
      new MessageFormatter('en_US', null);
    } catch (\IntlException $e) {
    // è¿™é‡Œå°†è·‘å‡º Constructor failed
    }

### å¼•æ“å¼‚å¸¸

PHP 7.0åŸºæœ¬ä¸Šæ‰€æœ‰çš„fatalé”™è¯¯æˆ–è€…å¯æ•è·çš„fatalé”™è¯¯å‡ç§°ä¸ºengine exceptionsã€‚

è¿™ä¸€æ”¹å˜ä½¿å¾—æˆ‘ä»¬ä¸ä»…å¯ä»¥ä½¿ç”¨try...catchè¯­å¥ï¼Œè¿˜æœ‰ä»¥ä¸‹å¥½å¤„:

* finallyæ‰§è¡Œ
* __destruct()æ‰§è¡Œ
* register_shutdown_function()æ‰§è¡Œ
* å®¹æ˜“æ•è·
* stack traceä¿¡æ¯ï¼Œå®¹æ˜“debug

#### å¼‚å¸¸å±‚çº§

    Throwable
    â”œâ”€â”€ \Exception (implements \Throwable)
    â”‚   â”œâ”€â”€ \LogicException
    â”‚   â”‚   â”œâ”€â”€ \BadFunctionCallException
    â”‚   â”‚   â”‚   â””â”€â”€ \BadMethodCallException
    â”‚   â”‚   â”œâ”€â”€ \DomainException
    â”‚   â”‚   â”œâ”€â”€ \InvalidArgumentException
    â”‚   â”‚   â”œâ”€â”€ \LengthException
    â”‚   â”‚   â””â”€â”€ \OutOfRangeException
    â”‚   â””â”€â”€ \RuntimeException
    â”‚       â”œâ”€â”€ \OutOfBoundsException
    â”‚       â”œâ”€â”€ \OverflowException
    â”‚       â”œâ”€â”€ \RangeException
    â”‚       â”œâ”€â”€ \UnderflowException
    â”‚       â””â”€â”€ \UnexpectedValueException
    â””â”€â”€ \Error (implements \Throwable)
      â”œâ”€â”€ \AssertionError
      â”œâ”€â”€ \ArithmeticError
      â”œâ”€â”€ \DivisionByZeroError
      â”œâ”€â”€ \ParseError
      â””â”€â”€ \TypeError

* baseç±»ç”±Exceptionå˜ä¸ºäº†Throwable
* \Errorç”¨æ¥ä¸“é—¨å¤„ç†engine exception

### Errorå¼‚å¸¸

æ ¹æ®ä¹‹å‰åˆ—å‡ºçš„å¼‚å¸¸å±‚çº§ï¼Œæ–°å¢äº†å››ä¸ªæ–°çš„errorå¼‚å¸¸ã€‚

#### \Error

æ ‡å‡†PHP fatalå’Œcatchable-fataléƒ½æŠ›å‡º\Errorå¼‚å¸¸ã€‚æœªæ•è·çš„è¯è¿˜æ˜¯ä¼šåƒâ€œä¼ ç»Ÿâ€ä¸€æ ·å¼•å‘é”™è¯¯ã€‚

ä¾‹å¦‚è°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°å°†æŠ›å‡º\Error exceptionï¼Œå¹¶å¸¦æœ‰é”™è¯¯ä¿¡æ¯ï¼šFatal error: Uncaught Error: Call to undefined function non_existant_function().

    try {
    non_existant_function();
    } catch (\Error $e) {
    // handle error
    printf("%s\n", $e->getMessage());
    }
    
#### \AssertionError

å¦‚æœå°†INI(æˆ–è€…ini_set())ä¸­assert.exceptioné…ç½®ä¸º1ï¼Œæ–­è¨€å¤±è´¥åä¼šæŠ›å‡ºè¯¥å¼‚å¸¸

    try {
      ini_set('assert.exception', 1);
      assert('true === false', 'Assertion failed');
    } catch (\AssertionError $e) {
    
    }

#### \ArithmeticError and \DivisionByZeroError

ç®—æœ¯å¼‚å¸¸

#### \ParseError

ä½ å¯ä»¥åœ¨includeã€requireå’Œevalè¯­å¥æ•è·è§£æé”™è¯¯

    try {
      include 'parse-error.php';
    } catch (\ParseError $e) {
    
    }

#### \TypeError

å¦‚æœç±»å‹ä¸åŒ¹é…å°†æŠ›å‡ºè¯¥å¼‚å¸¸

    function example(callable $callback)
    {
      return $callback();
    }

    try {
      example(new stdClass);
    } catch (\TypeError $e) {
    
    }

### å¯æ•è·çš„Fatalé”™è¯¯

ä¹‹å‰å¯ä»¥é€šè¿‡set_error_handler()æ¥å¤„ç†ï¼Œç°åœ¨å¯ä»¥é€šè¿‡\Errorå¼‚å¸¸æ•è·ï¼Œå¦‚æœéœ€è¦å…¼å®¹çš„è¯ä½ å¿…é¡»ä¸¤ä¸ªéƒ½è¿›è¡Œå¤„ç†ã€‚

### \Throwable å’Œ Userland

è™½ç„¶ç°åœ¨baseç±»æ˜¯\Throwableï¼Œä½†å¦‚æœéœ€è¦è‡ªå®šä¹‰å¼‚å¸¸çš„è¯ä½ ä»ç„¶éœ€è¦é€šè¿‡å‡ æˆ\Exceptionå’Œ\Errorï¼Œå› ä¸º\Throwableå°†æ— æ³•è¿½è¸ªåˆ°stack traceä¿¡æ¯,å¦‚æœç»§æ‰¿\Throwableå°†å¾—åˆ°ä»¥ä¸‹é”™è¯¯

    Fatal error: Class MyException cannot implement
    interface Throwable, extend Exception or Error instead

### è°ƒç”¨éå¯¹è±¡æ–¹æ³•

PHP 7.0ä¹‹å‰ï¼Œå¦‚æœä½ å°è¯•è°ƒç”¨ä¸€ä¸ªéå¯¹è±¡å˜é‡æ–¹æ³•ï¼Œå°†è§¦å‘fatalé”™è¯¯ï¼Œå¹¶å¸¦æœ‰é”™è¯¯ä¿¡æ¯Call to a member function method() on a non-objectï¼Œç°åœ¨PHP 7.0ä¼šæŠ›å‡º\Errorå¼‚å¸¸ï¼Œå¯ä»¥ä½¿ç”¨try...catchè¿›è¡Œæ•è·ã€‚

## Unicode å¢å¼º

### \uè½¬ä¹‰Unicodeå­—ç¬¦
    
    echo "\u{1F422}"
    ğŸ¢

### æ–°å›½é™…åŒ–ç‰¹æ€§

å¤§éƒ¨åˆ†I18Nç‰¹æ€§æ”¾ç½®åœ¨ext/intlæ‰©å±•IntlCharç±»

### ä½¿ç”¨Unicodeå­—ç¬¦

è·å–å­—ç¬¦å

    IntlChar::charName("\u{1F422}")

ä¹Ÿå¯ä»¥æ£€æµ‹å­—ç¬¦ç±»å‹

    $char = "\u{F1}";
    IntlChar::isAlpha($char);
    IntlChar::isAlnum($char);
    IntlChar::isPunct($char);
    
## é—­åŒ…å¢å¼º

### è°ƒç”¨æ—¶ç»‘å®šé—­åŒ…

    class HelloWorld {
      private $greeting = "Hello";
    }
    
    $closure = function($whom) {
      echo $this->greeting . ' ' . $whom;
    };
    
    $obj = new HelloWorld();
    $closure->call($obj, 'World');

## ç”Ÿæˆå™¨æé«˜

### ç”Ÿæˆå™¨è¿”å›å€¼

PHP 5.5å¦‚æœç”Ÿæˆå™¨returnå€¼å°†ä¼šæŠ¥é”™ï¼ŒPHP 7æä¾›äº†Generator->getReturn()æ¥è·å–è¿”å›å€¼

    function helloGoodbye() {
      yield "Hello";
      yield " ";
      yield "World!";
    
      return "Goodbye Moon!";
    }
    
    $gen = helloGoodbye();
    
    foreach ($gen as $value) {
      echo $value;
    }
    
    echo $gen->getReturn();

### ç”Ÿæˆå™¨å§”æ‰˜

    function hello() {
       yield "Hello";
       yield " ";
       yield "World!";
    
       yield from goodbye();
    }
    
    function goodbye() {
     yield "Goodbye";
     yield " ";
     yield "Moon!";
    }
    
    $gen = hello();
    foreach ($gen as $value) {
     echo $value;
    }

## é¢å‘å¯¹è±¡ç¼–ç¨‹æ”¹å˜


### Context-Sensitive Lexer

æœ‰äº†è¿™ä¸ªå°±å…è®¸åœ¨ç±»é‡Œä½¿ç”¨64ä¸ªä¿ç•™å…³é”®å­—ä½œä¸ºæ ‡è¯†ç¬¦

### åºŸå¼ƒPHP 4æ„é€ å‡½æ•°æ–¹æ³•

    class Foo() {
        function Foo() {
            // Deprecated
        }
    }

### åˆ†ç»„ä½¿ç”¨Useå®šä¹‰

    // Original
    use Framework\Component\ClassA;
    use Framework\Component\ClassB as ClassC;
    use Framework\OtherComponent\ClassD;
    
    // With group use statements
    use Framework\{
       Component\ClassA,
       Component\ClassB as ClassC,
       OtherComponent\ClassD
    };
    
    use Framework\Component\{
       Component\ClassA,
       Component\ClassB as ClassC
    };
    Use Framework\OtherComponent\ClassD;
    
    
    use Framework\Component\{
       SubComponent\ClassA,
       function OtherComponent\someFunction,
       const OtherComponent\SOME_CONSTANT
    };
    
### åŒ¿åç±»

    $object = new class("bar") {
      public $foo;
      public function __construct($arg)
      {
          $this->foo = $arg;
      }
    };


    namespace MyProject\Component;
    
    $object = new class ($args) extends Foo implements Bar {
    	use Bat;
    };

### åŒ¿åç±»å


    $objects = [];
    foreach (["foo", "foo", "bar"] as $value) {
          $objects[] = new class($value) {
    
              public $value;
    
              public function __construct($value)
              {
                  $this->value = $value;
              }
          };
    }

    $objects[] = new class("foo") {
    
      public $value;
    
      public function __construct($value)
      {
          $this->value = $value;
      }
    };


## ç±»å‹æç¤º

### æ ‡é‡ç±»å‹æç¤º

* bool
* float
* int
* string

    function hinted(bool $a, float $b, int $c, string $c)
    {
    
    }
    
    hinted(true, 4.35, 123, "foo");

#### å¼ºåˆ¶ç±»å‹

    function sendHttpStatus(int $statusCode, string $message)
    {
      header('HTTP/1.0 ' .$statusCode. ' ' .$message);
    }
    
    
    sendHttpStatus(404, "File Not Found");
    sendHttpStatus("403", "OK");

#### ç²¾åº¦é—å¤±

    
    function add(int $a, int $b)
    {
      return $a + $b;
    }
    
    add(897.23481, 361.53);

### ä¸¥æ ¼ç±»å‹

    // Enable strict types
    declare(strict_types=1);
    namespace MyProject\Component;
    
    hinted("foo", 123, 4.35, true);

å°†æŠ›å‡º\TypeErrorå¼‚å¸¸

### è¿”å›å€¼ç±»å‹æç¤º

    function divide(int $a, int $b): int
    {
      return $a / $b;
    }
    
    divide(4, 2);
    divide(5, 2);










